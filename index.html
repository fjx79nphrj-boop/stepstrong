<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="theme-color" content="#0f1117">
<title>Steadfast</title>
<style>
* { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
html, body, #root { min-height: 100vh; background: #0f1117; }
body { overscroll-behavior: none; }
</style>
<script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.9/babel.min.js"></script>
<script>
// Suppress Babel in-browser warning
(function() {
  var origWarn = console.warn;
  console.warn = function() {
    if (arguments[0] && typeof arguments[0] === 'string' && arguments[0].indexOf('in-browser Babel') !== -1) return;
    origWarn.apply(console, arguments);
  };
})();
</script>
</head>
<body>
<div id="root"></div>
<script type="text/babel" data-type="module">
const { useState, useEffect, useRef, useMemo } = React;



/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   STEADFAST â€” Stepparent Relationship Tracker 
   Local-first PWA â€¢ No backend â€¢ IndexedDB
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

// â”€â”€ Fonts: system fonts only (no external requests) â”€â”€

// â”€â”€ IndexedDB â”€â”€
const DB = "steadfast_v1";
const VER = 1;
const S = { entries: "entries", profile: "profile", snapshots: "snapshots" };

function idb() {
  return new Promise((ok, fail) => {
    const r = indexedDB.open(DB, VER);
    r.onupgradeneeded = (e) => {
      const d = e.target.result;
      if (!d.objectStoreNames.contains(S.entries)) {
        const s = d.createObjectStore(S.entries, { keyPath: "id" });
        s.createIndex("date", "date");
      }
      if (!d.objectStoreNames.contains(S.profile))
        d.createObjectStore(S.profile, { keyPath: "key" });
      if (!d.objectStoreNames.contains(S.snapshots))
        d.createObjectStore(S.snapshots, { keyPath: "id" });
    };
    r.onsuccess = () => ok(r.result);
    r.onerror = () => fail(r.error);
  });
}
async function put(s, d) { const db = await idb(); return new Promise((ok, f) => { const t = db.transaction(s, "readwrite"); t.objectStore(s).put(d); t.oncomplete = () => ok(); t.onerror = () => f(t.error); }); }
async function getAll(s) { const db = await idb(); return new Promise((ok, f) => { const r = db.transaction(s, "readonly").objectStore(s).getAll(); r.onsuccess = () => ok(r.result); r.onerror = () => f(r.error); }); }
async function get(s, k) { const db = await idb(); return new Promise((ok, f) => { const r = db.transaction(s, "readonly").objectStore(s).get(k); r.onsuccess = () => ok(r.result); r.onerror = () => f(r.error); }); }
async function del(s, k) { const db = await idb(); return new Promise((ok, f) => { const t = db.transaction(s, "readwrite"); t.objectStore(s).delete(k); t.oncomplete = () => ok(); t.onerror = () => f(t.error); }); }

// â”€â”€ Constants â”€â”€
const ACTIONS = [
  { id: "service", label: "Quiet act of service", icon: "ğŸ«§", c: "#7EB8A2" },
  { id: "activity", label: "Shared activity", icon: "ğŸ¯", c: "#8BAED4" },
  { id: "conversation", label: "Direct conversation", icon: "ğŸ’¬", c: "#C4A6D8" },
  { id: "gift", label: "Gift or treat", icon: "ğŸ", c: "#D4A574" },
  { id: "presence", label: "Being present", icon: "ğŸª‘", c: "#A8C5A0" },
  { id: "space", label: "Gave space", icon: "ğŸŒ¿", c: "#9DB8C7" },
  { id: "boundary", label: "Boundary-setting", icon: "ğŸ›¡ï¸", c: "#C9A0A0" },
];

const RESPONSES = [
  { id: "positive", label: "Positive engagement", icon: "âœ¨", c: "#7EB8A2", score: 4 },
  { id: "neutral", label: "Neutral acknowledgment", icon: "â–", c: "#9DB8C7", score: 3 },
  { id: "withdrawal", label: "Passive withdrawal", icon: "ğŸšª", c: "#C9A0A0", score: 2 },
  { id: "rejection", label: "Active rejection", icon: "ğŸ”´", c: "#D4796B", score: 1 },
  { id: "escalation", label: "Escalation", icon: "âš¡", c: "#B85C4F", score: 0 },
];

const CONTEXTS = [
  "Morning", "Afternoon", "Evening", "Night",
  "After custody transition", "After bio-parent contact",
  "After discipline moment", "During shared activity",
  "At mealtime", "At bedtime", "Weekend", "School day",
  "Holiday / special occasion", "After argument with partner",
];

const CARDS = [
  {
    triggers: ["rejection", "escalation"],
    title: "The Loyalty Bind",
    body: "Children often reject stepparents not because they dislike them, but because acceptance feels like betraying their biological parent. The rejection you're feeling is rarely about you â€” it's about the impossible emotional math the child is trying to solve.",
    src: "Braithwaite et al., 2018",
    quote: "\"It was all in my head. I wouldn't want to go out with my dad's family, because I didn't feel comfortable, nor did I feel like I fit in. It wasn't my stepmom's fault, nor my dad's.\"",
    who: "Former stepchild, now 30",
  },
  {
    triggers: ["rejection"],
    title: "What They'll Remember",
    body: "Adult stepchildren consistently report that the things they remember most are NOT grand gestures. It's the ironed shirt. The medicine left without a word. The college fees paid quietly. Things done without any expectation of acknowledgment.",
    quote: "\"She stopped trying to bond. But she still left medicine on my bedside when I was sick. Still paid my college application fees quietly. On my first job interview day, she ironed my shirt and said nothing else. That hurt more than any argument.\"",
    who: "Adult stepchild reflection",
  },
  {
    triggers: ["rejection", "escalation"],
    title: "\"You're Not My Real Parent\"",
    body: "This phrase is the most commonly cited verbal weapon. But research shows it reflects the child's fear of losing their biological parent, not a genuine assessment. Children use it precisely because they know it will land â€” which paradoxically means the relationship matters enough to weaponize.",
    quote: "\"I'm sorry I never gave you a chance; a fair, equal chance. I compared you to my father, and thought you were stealing my mother. I was afraid I was losing her. You taught me what a man should be to a woman.\"",
    who: "Adult stepchild, looking back",
  },
  {
    triggers: ["withdrawal"],
    title: "Withdrawal Isn't Rejection",
    body: "When a child withdraws â€” leaves the room, goes silent, avoids â€” it feels like rejection. But withdrawal is often a self-protective mechanism, not an offensive one. The child may be overwhelmed, processing, or simply not ready. Withdrawal is often a sign they're aware of the relationship, not indifferent to it.",
    quote: "\"When I felt her pullback as a kid, I felt she didn't care if I was there or not as long as she had my dad. And that's what we don't want our bonus children thinking, they aren't wanted.\"",
    who: "Former stepchild perspective",
  },
  {
    triggers: ["neutral", "positive"],
    title: "Neutral Is Progress",
    body: "In stepfamily dynamics, a neutral response IS a positive signal. If the child accepted what you offered without resistance â€” even without warmth â€” that's movement. The path typically goes: hostility â†’ avoidance â†’ tolerance â†’ neutral acceptance â†’ occasional warmth. You may be further along than you think.",
    src: "Stepfamily integration typically takes 7â€“12 years. Neutral acceptance is a major milestone.",
  },
  {
    triggers: ["rejection", "withdrawal", "escalation"],
    title: "The 2 AM Truth",
    body: "Right now, everything feels amplified. The rejection feels permanent. The effort feels wasted. But the stepparents who eventually break through are the ones who maintained consistent, low-pressure presence through exactly these moments. Your exhaustion is evidence of your commitment, not your failure.",
    quote: "\"My car broke down on a highway at 2 am. I called him because my phone was dying. He reached in 40 minutes. Didn't lecture me. Just fixed the issue and waited till I got home. Later, he said, 'I know I'm not your first call. I just want to be a reliable one.'\"",
    who: "Adult stepchild about their stepdad",
  },
  {
    triggers: ["rejection", "withdrawal", "escalation"],
    title: "You're Not Becoming Someone Else",
    body: "Feeling angry, resentful, or withdrawn doesn't mean you're becoming a bad stepparent. It means you're a committed adult experiencing sustained emotional labor without feedback. These feelings are a measurement problem, not a character flaw.",
    quote: "\"I was experiencing an identity crisis as a stepmom. Not loving your stepchildren or feeling resentful or jealous does not make you a bad stepmom.\"",
    who: "Stepmom community post",
  },
  {
    triggers: ["positive", "neutral"],
    title: "Anchor This Moment",
    body: "Your brain is wired to weigh negative interactions more heavily than positive ones. This moment â€” this neutral or positive response â€” is real data. It happened. When the next difficult moment comes, you'll have concrete evidence that progress exists.",
    src: "Negativity bias causes humans to weight negative events 3â€“5Ã— more heavily than positive ones.",
  },
];

// â”€â”€ Daily Quotes (shown on Home, one per day) â”€â”€
const DAILY_QUOTES = [
  // === REJECTION / ACTIVE RESISTANCE ===
  { q: "I'm sorry I never gave you a chance. I compared you to my father, and thought you were stealing my mother. I was afraid I was losing her. You taught me what a man should be to a woman.", who: "Adult stepchild, looking back", theme: "rejection" },
  { q: "She stopped trying to bond. But she still left medicine on my bedside when I was sick. Still paid my college application fees quietly. On my first job interview day, she ironed my shirt and said nothing else. That hurt more than any argument.", who: "Adult stepchild reflection", theme: "invisible-effort" },
  { q: "My car broke down on a highway at 2 AM. I called him because my phone was dying. He came in 40 minutes. Didn't lecture me. Just fixed the issue and waited till I got home. He said, 'I know I'm not your first call. I just want to be a reliable one.'", who: "Adult stepchild about their stepdad", theme: "invisible-effort" },
  { q: "It was all in my head. I wouldn't want to go out with my dad's family, because I didn't feel comfortable. It wasn't my stepmom's fault, nor my dad's.", who: "Former stepchild, now 30", theme: "rejection" },
  { q: "I hated her for years. Not because she was bad â€” because she was there, and my mom wasn't. That's not fair, and I know that now. But a kid doesn't know that.", who: "Adult stepchild, age 28", theme: "rejection" },
  // === INVISIBLE EFFORT / LONG GAME ===
  { q: "He never tried to be my dad. He just kept showing up. Drove me places. Fixed things. Asked how school was, even when I gave one-word answers for three years straight. I didn't appreciate it until I was 25.", who: "Former stepchild about stepdad", theme: "invisible-effort" },
  { q: "She made my lunch every day for five years and I never once said thank you. I think about that a lot now that I have my own kids.", who: "Adult stepchild, now a parent", theme: "invisible-effort" },
  { q: "The thing I remember most isn't any big conversation. It's that he always saved me the corner piece of the brownies. Every single time. He noticed that about me when nobody else did.", who: "Adult stepchild, age 32", theme: "invisible-effort" },
  { q: "I used to slam my door every time she spoke to me. She never stopped knocking. Not to come in â€” just to say goodnight through the door. Every night for two years.", who: "Former stepchild, now 26", theme: "invisible-effort" },
  { q: "When I got married, I asked my stepdad to walk me down the aisle. My mom cried. He cried. I cried. He had waited seventeen years for that moment and never once asked for it.", who: "Adult stepdaughter", theme: "long-view" },
  // === PROGRESS / HOPE ===
  { q: "The shift didn't happen all at once. One day I just realized I'd started calling her house 'home' without thinking about it.", who: "Former stepchild, age 24", theme: "progress" },
  { q: "I named my daughter after my stepmom. She doesn't know yet. I'm telling her at Christmas.", who: "Adult stepchild", theme: "long-view" },
  { q: "It took me until I was 22 to tell him I loved him. But I'd felt it since I was 16. I just didn't know how to say it without feeling like I was betraying my real dad.", who: "Adult stepchild about loyalty conflict", theme: "progress" },
  { q: "My stepmom never corrected me when I called her by her first name. She never pushed. And that's exactly why, twenty years later, my kids call her grandma.", who: "Adult stepchild, now 38", theme: "long-view" },
  // === VALIDATION / IDENTITY ===
  { q: "I wish someone had told my stepdad that my silence wasn't rejection. I was just scared that if I loved him, it meant I didn't love my dad anymore.", who: "Former stepchild, now 27", theme: "rejection" },
  { q: "The hardest part wasn't that she rejected me. It was that I started to believe I was the problem. I wasn't. The situation was the problem.", who: "Stepparent of 8 years", theme: "identity" },
  { q: "Nobody told me that 'doing fine' was a realistic best-case for the first five years. I kept thinking I was failing when I was actually right on track.", who: "Stepdad, year 7", theme: "identity" },
  { q: "You don't have to love your stepkids the same way you love your bio kids. Different love is still love. I wish someone had given me permission to feel that earlier.", who: "Stepmom, blended family", theme: "identity" },
  // === ADDITIONAL FOR DAILY ROTATION ===
  { q: "Looking back, the fact that she stayed is the thing that mattered. Not what she said, not what she bought me. She just stayed.", who: "Adult stepchild, age 30", theme: "invisible-effort" },
  { q: "I wrote my stepmom a letter when I turned 30. Just to say sorry. And thank you. She framed it.", who: "Adult stepchild", theme: "long-view" },
  { q: "He came to every single game. Even when I pretended he wasn't there. Especially when I pretended he wasn't there.", who: "Former stepchild about stepdad", theme: "invisible-effort" },
  { q: "My stepmother taught me that family isn't just blood. It's who stays when things are hard. She stayed.", who: "Adult stepchild, age 35", theme: "long-view" },
  { q: "I used to test her constantly. Say horrible things just to see if she'd leave. She never did. That's the only reason I trust anyone now.", who: "Former stepchild, now in therapy", theme: "rejection" },
  { q: "The relationship didn't get good. It got okay. And okay turned out to be more than enough.", who: "Adult stepchild about realistic outcomes", theme: "progress" },
  { q: "I didn't go to her funeral because I was angry. I regret it every single day. She deserved better from me, and she probably knew that.", who: "Adult stepchild, age 45", theme: "long-view" },
];

// â”€â”€ Partner Communication Tips â”€â”€
const PARTNER_TIPS = [
  {
    title: "Make the invisible visible",
    situation: "Your partner doesn't seem to notice your efforts with their child.",
    tip: "Don't wait for them to notice. Share specific moments: 'I made their lunch today and they walked past me without a word. I know that's normal, but it would help me to hear that you see what I'm doing.'",
    why: "Partners often assume stepparents know their efforts are appreciated. They don't realize you need explicit acknowledgment because you're not getting any from the child.",
  },
  {
    title: "The united front conversation",
    situation: "You feel undermined when your partner overrides your decisions in front of the child.",
    tip: "Try: 'When we disagree about rules, can we talk about it privately first? When it happens in front of the kids, it signals that I don't have authority here â€” and that makes it harder for them to respect me.'",
    why: "Children in stepfamilies are highly attuned to power dynamics. If they see the bio-parent override the stepparent, it confirms their belief that the stepparent doesn't count.",
  },
  {
    title: "Don't compete with the other parent",
    situation: "Your partner compares you to the child's other biological parent, or expects you to fill that role.",
    tip: "Say: 'I'm not trying to replace anyone. I'm trying to build my own relationship with your child. That takes time, and it will look different from what they have with their other parent â€” and that's okay.'",
    why: "Stepparents who try to replicate the bio-parent role face the most resistance. Research consistently shows that a 'friendly mentor' role leads to better outcomes than a 'replacement parent' role.",
  },
  {
    title: "When you need space from the child",
    situation: "You need a break but feel guilty asking.",
    tip: "Try: 'I need an hour to reset after today. That's not me giving up â€” it's me making sure I can show up again tomorrow. Can you handle bedtime tonight?'",
    why: "Stepparent burnout is real and under-discussed. Taking breaks isn't abandonment. Partners need to understand that sustained effort requires recovery.",
  },
  {
    title: "Sharing your Steadfast data",
    situation: "Your partner asks how things are going, and you want to show them â€” not just tell them.",
    tip: "Use the monthly report to share patterns: 'Look â€” when I use quiet acts of service, the response is neutral or positive 70% of the time. Direct conversation only works 30%. This is real data, not just my feelings.'",
    why: "Data removes the emotion from the conversation. Your partner can see objective patterns instead of hearing what might sound like complaints.",
  },
  {
    title: "When your partner says 'just give it time'",
    situation: "You're struggling and your partner minimizes it with 'they'll come around.'",
    tip: "Respond: 'I hear you, and I know time matters. But right now, I need you to acknowledge that this is hard â€” not solve it, just see it. Can you just sit with me in this for a minute?'",
    why: "'Give it time' feels dismissive even when it's true. What stepparents need in the moment is validation, not advice. Partners often default to fixing because the pain is uncomfortable to witness.",
  },
  {
    title: "Asking for backup without starting a fight",
    situation: "The child was disrespectful to you and your partner didn't intervene.",
    tip: "Wait until you're calm, then: 'When [specific thing] happened today and nothing was said, I felt unsupported. I'm not asking you to punish them â€” I'm asking you to say something in the moment, even something small, so they know that's not okay.'",
    why: "Bio-parents often freeze when caught between their child and their partner. They need specific, small requests â€” not general demands to 'do something.'",
  },
  {
    title: "The loyalty conflict isn't about you",
    situation: "Your partner's child acts worse after visits with their other parent.",
    tip: "Tell your partner: 'I've noticed the pattern too. It's not about us doing something wrong â€” they're processing loyalty conflict. The best thing we can do is keep things calm and predictable when they come back.'",
    why: "Children often act out after custody transitions because they feel guilty for enjoying time with the other household. Naming this pattern together reduces blame.",
  },
];

// â”€â”€ Parental Alienation Content â”€â”€
const ALIENATION = {
  title: "When it's more than normal resistance",
  intro: "Parental alienation â€” when one parent actively turns a child against the other parent or stepparent â€” is a specific and severe dynamic that goes beyond typical stepfamily adjustment. If you're experiencing this, it's important to know that standard stepparenting strategies may not apply.",
  signs: [
    "The child repeats word-for-word phrases that sound like an adult's language, not a child's",
    "Rejection escalated suddenly after contact with the other parent, with no other trigger",
    "The child shows no ambivalence â€” they're entirely negative with zero mixed feelings",
    "Previously warm interactions disappeared overnight",
    "The child makes false accusations or dramatically rewrites shared history",
  ],
  guidance: [
    { title: "This is not your fault", text: "Alienation is a form of psychological manipulation by an adult. No amount of 'trying harder' on your part will fix it, because the problem isn't coming from you or the child." },
    { title: "Document, don't react", text: "Keep factual records of what the child says and when. Your Steadfast entries can serve this purpose. Note specific phrases, dates, and context â€” especially correlation with custody transitions." },
    { title: "Protect the relationship you can", text: "Focus on your relationship with your partner. Alienation puts enormous strain on couples. Your partner needs to be actively involved in addressing this â€” it cannot be your fight alone." },
    { title: "Seek specialized help", text: "General stepfamily advice often doesn't apply to alienation. Look for therapists who specifically work with parental alienation or high-conflict custody situations." },
    { title: "Lower your expectations without giving up", text: "Progress in alienation cases is measured differently. A child maintaining any neutral contact at all may be the realistic best outcome while the alienation is active. This doesn't mean forever." },
  ],
  note: "Steadfast's tracking tools can still be useful in alienation situations â€” documenting patterns, correlating behaviors with custody transitions, and maintaining your own perspective. But the perspective cards and benchmarks are designed for typical stepfamily resistance, not active alienation. If you're in this situation, please adjust your expectations of this app and of yourself.",
};

const BENCH = {
  ages: {
    "0-4": { t: "3â€“6 years", note: "Young children are generally more accepting but may develop resistance as they understand family dynamics." },
    "5-9": { t: "5â€“8 years", note: "School-age children have established bonds and may feel torn between loyalty to their biological parent and acceptance of you." },
    "10-13": { t: "7â€“12 years", note: "Pre-teens and early teens face the hardest adjustment. Identity formation plus loyalty conflicts create intense resistance." },
    "14-17": { t: "May extend into adulthood", note: "Teenagers are developmentally separating from ALL parents. Adding a new one at this stage is exceptionally challenging. Progress often only becomes visible when they're adults." },
  },
  custody: {
    full: "Living together full-time creates more friction but also more opportunities for small positive interactions.",
    "50-50": "Regular transitions can trigger loyalty conflicts each time. But consistent presence normalizes the relationship.",
    weekends: "Limited time means each interaction carries more weight â€” both positive and negative. Slower overall progress.",
    other: "Irregular or infrequent contact makes relationship-building significantly harder.",
  },
  loyalty: {
    none: "No visible loyalty conflict is a significant advantage. Progress may be faster than typical benchmarks.",
    mild: "Some tension is normal. The child may feel conflicted but isn't actively pressured to reject you.",
    strong: "Active loyalty conflict is the single biggest predictor of slower integration. This is the hardest variable, and it's not something you control.",
    unknown: "Not being sure is common. Watch for signs: does the child seem conflicted after visits with the other parent?",
  },
  outcomes: [
    { l: "Warm acceptance", d: "Genuine affection, seeks your company, introduces you as family.", p: "15â€“20%", c: "#7EB8A2" },
    { l: "Comfortable relationship", d: "Easy coexistence, shared activities, mutual respect.", p: "30â€“35%", c: "#8BAED4" },
    { l: "Respectful distance", d: "Polite, cooperative, but not close. A realistic and valid success state.", p: "25â€“30%", c: "#9DB8C7" },
    { l: "Cordial coexistence", d: "Functional household, minimal friction, limited emotional connection.", p: "15â€“20%", c: "#C9A0A0" },
    { l: "Ongoing difficulty", d: "Continued resistance that may soften in adulthood â€” or may not.", p: "5â€“10%", c: "#D4796B" },
  ],
};

const SNAP_Q = [
  { id: "overall", q: "How would you describe the relationship right now?", s: ["Hostile", "Avoidant", "Tense", "Neutral", "Warming", "Comfortable", "Close"] },
  { id: "rej", q: "How often are you experiencing overt rejection?", s: ["Daily", "Several/wk", "Weekly", "Few/month", "Rarely", "Almost never"] },
  { id: "pos", q: "How often do you notice small positive signals?", s: ["Never", "Rarely", "Sometimes", "Weekly", "Several/wk", "Daily"] },
  { id: "feeling", q: "How are YOU feeling about the relationship?", s: ["Hopeless", "Exhausted", "Discouraged", "Neutral", "Cautious hope", "Good", "Confident"] },
  { id: "identity", q: "How much are you feeling like yourself?", s: ["Lost", "Struggling", "Coping", "Mostly OK", "Myself", "Stronger"] },
  { id: "sustain", q: "How sustainable does your current effort feel?", s: ["Burning out", "Unsustainable", "Difficult", "Manageable", "Comfortable", "Natural"] },
];

// â”€â”€ Helpers â”€â”€
const uid = () => Date.now().toString(36) + Math.random().toString(36).slice(2, 7);
const fmtDate = (d) => new Date(d).toLocaleDateString("en-US", { month: "short", day: "numeric", year: "numeric" });
const fmtShort = (d) => new Date(d).toLocaleDateString("en-US", { month: "short", day: "numeric" });
const daysAgo = (d) => Math.round((Date.now() - new Date(d).getTime()) / 86400000);

// â”€â”€ Palette â”€â”€
const P = {
  bg: "#0f1117", card: "#161921", card2: "#1c2029", border: "#252a35",
  border2: "#2f3542", warm: "#D4A574", warmDim: "#D4A57444",
  text: "#E5D5C5", muted: "#9CA3AF", dim: "#6B7280", dimmer: "#4B5563",
  green: "#7EB8A2", blue: "#8BAED4", purple: "#C4A6D8", rose: "#C9A0A0", red: "#D4796B",
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  MAIN APP
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function App() {
  const [view, setView] = useState("loading");
  const [entries, setEntries] = useState([]);
  const [profile, setProfile] = useState(null);
  const [snaps, setSnaps] = useState([]);
  const [modal, setModal] = useState(null); // {type, data?}
  const [timeRange, setTimeRange] = useState("3m");
  const [patMode, setPatMode] = useState("action");

  useEffect(() => {
    (async () => {
      try {
        const [e, p, s] = await Promise.all([getAll(S.entries), get(S.profile, "main"), getAll(S.snapshots)]);
        setEntries(e.sort((a, b) => new Date(b.date) - new Date(a.date)));
        setProfile(p?.data || null);
        setSnaps(s.sort((a, b) => new Date(a.date) - new Date(b.date)));
        setView(p?.data ? "home" : "onboard");
      } catch { setView("onboard"); }
    })();
  }, []);

  const saveEntry = async (e) => { await put(S.entries, e); setEntries(prev => [e, ...prev.filter(x => x.id !== e.id)].sort((a, b) => new Date(b.date) - new Date(a.date))); };
  const delEntry = async (id) => { await del(S.entries, id); setEntries(prev => prev.filter(x => x.id !== id)); };
  const saveProfile = async (d) => { await put(S.profile, { key: "main", data: d }); setProfile(d); };
  const saveSnap = async (s) => { await put(S.snapshots, s); setSnaps(prev => [...prev.filter(x => x.id !== s.id), s].sort((a, b) => new Date(a.date) - new Date(b.date))); };
  const delSnap = async (id) => { await del(S.snapshots, id); setSnaps(prev => prev.filter(x => x.id !== id)); };

  const exportData = () => {
    const d = JSON.stringify({ entries, profile, snapshots: snaps, exported: new Date().toISOString() }, null, 2);
    const a = document.createElement("a");
    a.href = URL.createObjectURL(new Blob([d], { type: "application/json" }));
    a.download = `steadfast-backup-${new Date().toISOString().slice(0, 10)}.json`;
    a.click();
  };

  const importData = (evt) => {
    const f = evt.target.files[0];
    if (!f) return;
    const r = new FileReader();
    r.onload = async (e) => {
      try {
        const d = JSON.parse(e.target.result);
        if (d.entries) for (const x of d.entries) await put(S.entries, x);
        if (d.profile) await put(S.profile, { key: "main", data: d.profile });
        if (d.snapshots) for (const x of d.snapshots) await put(S.snapshots, x);
        window.location.reload();
      } catch { alert("Invalid backup file."); }
    };
    r.readAsText(f);
  };

  const openEntry = (e = null) => setModal({ type: "entry", data: e });
  const close = () => setModal(null);

  if (view === "loading") return (
    <div style={{ ...css.root, display: "flex", alignItems: "center", justifyContent: "center", minHeight: "100vh" }}>
      <p style={{ color: P.dim, fontFamily: "Georgia, 'Times New Roman', serif", fontSize: 18 }}>Loading...</p>
    </div>
  );

  if (view === "onboard") return <Onboarding onDone={(d) => { saveProfile(d); setView("home"); }} />;

  return (
    <div style={css.root}>
      <div style={css.shell}>
        {/* Modal layer */}
        {modal?.type === "entry" && (
          <EntryModal
            entry={modal.data}
            onSave={(e) => {
              saveEntry(e); close();
              if (e.response === "rejection" || e.response === "escalation") {
                const cs = CARDS.filter(c => c.triggers.includes(e.response));
                if (cs.length) setTimeout(() => setModal({ type: "card", data: cs[Math.floor(Math.random() * cs.length)] }), 300);
              }
            }}
            onDelete={modal.data ? (id) => { delEntry(id); close(); } : null}
            onClose={close}
          />
        )}
        {modal?.type === "card" && <CardModal card={modal.data} onClose={close} />}
        {modal?.type === "snap" && <SnapModal snaps={snaps} onSave={(s) => { saveSnap(s); close(); }} onClose={close} />}
        {modal?.type === "settings" && <SettingsModal onClose={close} onExport={exportData} onImport={importData} onRedo={() => { setView("onboard"); close(); }} />}

        {/* Header */}
        <header style={css.hdr}>
          <div>
            <h1 style={css.logo}>Steadfast</h1>
            <p style={css.sub}>Your progress is real, even when it's invisible</p>
          </div>
          <button onClick={() => setModal({ type: "settings" })} style={css.iconBtn} aria-label="Settings">âš™</button>
        </header>

        <Nav view={view} go={setView} />

        <main style={{ padding: "4px 16px 120px" }}>
          {view === "home" && <Home entries={entries} profile={profile} snaps={snaps} openEntry={openEntry} openSnap={() => setModal({ type: "snap" })} openCard={() => { const c = CARDS[Math.floor(Math.random() * CARDS.length)]; setModal({ type: "card", data: c }); }} />}
          {view === "timeline" && <Timeline entries={entries} snaps={snaps} range={timeRange} setRange={setTimeRange} openEntry={openEntry} />}
          {view === "patterns" && <Patterns entries={entries} mode={patMode} setMode={setPatMode} />}
          {view === "perspective" && <Perspective entries={entries} openCard={(c) => setModal({ type: "card", data: c })} />}
          {view === "partner" && <Partner entries={entries} profile={profile} snaps={snaps} />}
          {view === "benchmark" && <Benchmark profile={profile} snaps={snaps} entries={entries} openSnap={() => setModal({ type: "snap" })} onDeleteSnap={delSnap} />}
        </main>

        {/* FAB */}
        <button onClick={() => openEntry()} style={css.fab} aria-label="Log interaction">
          <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
        </button>
      </div>
    </div>
  );
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  NAVIGATION
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function Nav({ view, go }) {
  const items = [
    { id: "home", label: "Home", ico: "âŠ™" },
    { id: "timeline", label: "Timeline", ico: "â”" },
    { id: "patterns", label: "Patterns", ico: "â—«" },
    { id: "perspective", label: "Shift", ico: "â—‡" },
    { id: "partner", label: "Partner", ico: "â™¡" },
    { id: "benchmark", label: "Bench", ico: "â–³" },
  ];
  return (
    <nav style={css.nav}>
      {items.map(i => (
        <button key={i.id} onClick={() => go(i.id)} style={{ ...css.navBtn, color: view === i.id ? P.warm : P.dim, borderBottom: view === i.id ? `2px solid ${P.warm}` : "2px solid transparent" }}>
          <span style={{ fontSize: 15 }}>{i.ico}</span>
          <span style={{ fontSize: 10 }}>{i.label}</span>
        </button>
      ))}
    </nav>
  );
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  HOME
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function Home({ entries, profile, snaps, openEntry, openSnap, openCard }) {
  const today = new Date().toISOString().slice(0, 10);
  const todayN = entries.filter(e => e.date.slice(0, 10) === today).length;
  const week = entries.filter(e => daysAgo(e.date) <= 7);
  const weekPos = week.filter(e => e.response === "positive" || e.response === "neutral").length;
  const days = profile?.startDate ? daysAgo(profile.startDate) : 0;
  const lastSnap = snaps.length ? snaps[snaps.length - 1] : null;
  const snapDue = !lastSnap || daysAgo(lastSnap.date) >= 28;

  // Daily quote - deterministic based on day number since epoch
  const dayNum = Math.floor(Date.now() / 86400000);
  const dailyQuote = DAILY_QUOTES[dayNum % DAILY_QUOTES.length];

  return (
    <div>
      {/* Daily quote */}
      <div style={{ ...css.card, padding: 20, marginBottom: 12, borderLeft: `3px solid ${P.warm}44`, background: `linear-gradient(135deg, ${P.card} 0%, #1a1520 100%)` }}>
        <p style={{ color: P.text, fontSize: 14, lineHeight: 1.7, fontStyle: "italic", margin: 0 }}>"{dailyQuote.q}"</p>
        <p style={{ color: P.warm, fontSize: 11, margin: "10px 0 0", opacity: 0.8 }}>â€” {dailyQuote.who}</p>
      </div>
      {/* CTA card */}
      <div style={{ ...css.card, background: `linear-gradient(135deg, ${P.card} 0%, ${P.card2} 100%)`, padding: 24, marginBottom: 12 }}>
        <p style={{ color: P.muted, margin: "0 0 14px", fontSize: 15 }}>
          {todayN === 0 ? "How did things go today?" : `${todayN} interaction${todayN > 1 ? "s" : ""} logged today.`}
        </p>
        <Btn onClick={() => openEntry()}>Log an Interaction</Btn>
      </div>

      {/* Stats */}
      <div style={{ display: "flex", gap: 8, marginBottom: 12 }}>
        <Stat n={days} l="days tracking" />
        <Stat n={entries.length} l="total logged" />
        <Stat n={week.length > 0 ? Math.round((weekPos / week.length) * 100) + "%" : "â€”"} l="positive this wk" />
      </div>

      {/* Snapshot prompt */}
      {snapDue && (
        <button onClick={openSnap} style={css.prompt}>
          <span style={{ fontSize: 16 }}>ğŸ“Š</span>
          <div style={{ flex: 1 }}>
            <div style={{ color: P.text, fontSize: 14, fontWeight: 500 }}>Monthly check-in {lastSnap ? "due" : "available"}</div>
            <div style={{ color: P.dim, fontSize: 12, marginTop: 2 }}>
              {lastSnap ? `Last snapshot was ${daysAgo(lastSnap.date)} days ago.` : "Take your first snapshot to start tracking progress."} Compare where things stand over time.
            </div>
          </div>
        </button>
      )}

      {/* Perspective shortcut */}
      <button onClick={openCard} style={{ ...css.prompt, borderColor: "#29232e" }}>
        <span style={{ fontSize: 16 }}>â—‡</span>
        <div style={{ flex: 1 }}>
          <div style={{ color: P.text, fontSize: 14, fontWeight: 500 }}>Need a perspective shift?</div>
          <div style={{ color: P.dim, fontSize: 12, marginTop: 2 }}>Research-backed reframes for when things feel heavy.</div>
        </div>
      </button>

      {/* Recent */}
      {entries.length > 0 && <SectionTitle>Recent</SectionTitle>}
      {entries.slice(0, 5).map(e => <EntryRow key={e.id} entry={e} onClick={() => openEntry(e)} />)}
    </div>
  );
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  TIMELINE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function Timeline({ entries, snaps, range, setRange, openEntry }) {
  const ranges = { "1m": 30, "3m": 90, "6m": 180, "1y": 365, all: 99999 };
  const cut = Date.now() - ranges[range] * 86400000;
  const fil = useMemo(() =>
    entries.filter(e => new Date(e.date).getTime() >= cut).sort((a, b) => new Date(a.date) - new Date(b.date)),
    [entries, cut]
  );

  // Group by calendar date string (YYYY-MM-DD in local time)
  const groups = useMemo(() => {
    const m = {};
    fil.forEach(e => {
      const d = new Date(e.date);
      const k = `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, "0")}-${String(d.getDate()).padStart(2, "0")}`;
      if (!m[k]) m[k] = [];
      m[k].push(e);
    });
    return Object.entries(m).sort(([a], [b]) => a.localeCompare(b)).map(([k, v]) => ({ key: k, entries: v }));
  }, [fil]);

  const scores = groups.map(g => {
    const s = g.entries.map(e => RESPONSES.find(r => r.id === e.response)?.score ?? 2);
    return { ...g, avg: s.reduce((a, b) => a + b, 0) / s.length, count: g.entries.length };
  });

  // Small multiples: per response type, daily count over time
  const [seriesFilter, setSeriesFilter] = useState("all");
  const seriesData = useMemo(() => {
    const allDates = groups.map(g => g.key);
    return RESPONSES.map(r => {
      const counts = groups.map(g => g.entries.filter(e => e.response === r.id).length);
      return { ...r, counts, dates: allDates };
    });
  }, [groups]);

  // Simple moving average trendline (window=3)
  const trend = (arr) => {
    if (arr.length < 3) return arr;
    return arr.map((_, i) => {
      const start = Math.max(0, i - 1);
      const end = Math.min(arr.length, i + 2);
      const slice = arr.slice(start, end);
      return slice.reduce((a, b) => a + b, 0) / slice.length;
    });
  };

  const fmtKey = (k) => {
    const [y, m, d] = k.split("-");
    const months = ["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];
    return `${months[parseInt(m) - 1]} ${parseInt(d)}`;
  };

  // SVG small multiple chart
  const SmallMultiple = ({ data, maxY }) => {
    const w = 280, h = 50, padL = 0, padR = 4;
    const n = data.counts.length;
    if (n === 0) return null;
    const cMax = Math.max(maxY, 1);
    const xStep = n > 1 ? (w - padL - padR) / (n - 1) : 0;

    const points = data.counts.map((c, i) => ({ x: padL + i * xStep, y: h - (c / cMax) * (h - 4) }));
    const trendVals = trend(data.counts);
    const trendPts = trendVals.map((c, i) => ({ x: padL + i * xStep, y: h - (c / cMax) * (h - 4) }));

    const pathD = points.map((p, i) => `${i === 0 ? "M" : "L"}${p.x},${p.y}`).join(" ");
    const trendD = trendPts.map((p, i) => `${i === 0 ? "M" : "L"}${p.x},${p.y}`).join(" ");

    return (
      <svg viewBox={`0 0 ${w} ${h}`} style={{ width: "100%", height: h, display: "block" }}>
        {/* Grid line at 0 */}
        <line x1={padL} y1={h} x2={w - padR} y2={h} stroke={P.border} strokeWidth="0.5" />
        {/* Data line */}
        {n > 1 ? (
          <>
            <path d={pathD} fill="none" stroke={data.c} strokeWidth="1.5" opacity="0.4" />
            <path d={trendD} fill="none" stroke={data.c} strokeWidth="2" />
          </>
        ) : (
          <circle cx={points[0].x} cy={points[0].y} r="3" fill={data.c} />
        )}
        {/* Dots */}
        {points.map((p, i) => <circle key={i} cx={p.x} cy={p.y} r="2" fill={data.c} opacity="0.6" />)}
      </svg>
    );
  };

  const globalMaxDaily = useMemo(() => {
    let mx = 0;
    groups.forEach(g => {
      RESPONSES.forEach(r => {
        const c = g.entries.filter(e => e.response === r.id).length;
        if (c > mx) mx = c;
      });
    });
    return mx;
  }, [groups]);

  const filteredSeries = seriesFilter === "all" ? seriesData : seriesData.filter(s => s.id === seriesFilter);

  return (
    <div>
      <Tabs items={Object.keys(ranges).map(r => r === "all" ? "All" : r)} active={range === "all" ? "All" : range} onPick={(v) => setRange(v === "All" ? "all" : v)} />

      {fil.length === 0 ? (
        <div style={{ textAlign: "center", padding: "48px 20px" }}>
          <p style={{ color: P.dim }}>No entries in this range yet.</p>
        </div>
      ) : (
        <>
          {/* Daily tone bar chart */}
          <div style={{ ...css.card, padding: 16, marginBottom: 12 }}>
            <p style={{ color: P.dim, fontSize: 12, margin: "0 0 10px" }}>Daily emotional tone (taller = more positive)</p>
            <div style={{ display: "flex", gap: 2, alignItems: "flex-end", height: 80 }}>
              {scores.map((g, i) => {
                const hPx = Math.max(Math.round((g.avg / 4) * 70), 4);
                const c = g.avg >= 3 ? P.green : g.avg >= 2 ? P.blue : g.avg >= 1 ? P.rose : P.red;
                return (
                  <div key={i} style={{ flex: 1, maxWidth: 28 }}>
                    <div style={{ width: "100%", height: hPx, background: c, borderRadius: "3px 3px 0 0" }} />
                  </div>
                );
              })}
            </div>
            <div style={{ display: "flex", gap: 10, marginTop: 10, flexWrap: "wrap" }}>
              <span style={{ fontSize: 10, color: P.red }}>â— Very hard</span>
              <span style={{ fontSize: 10, color: P.rose }}>â— Difficult</span>
              <span style={{ fontSize: 10, color: P.blue }}>â— Mixed</span>
              <span style={{ fontSize: 10, color: P.green }}>â— Positive</span>
            </div>
          </div>

          {/* Small multiples time series */}
          {groups.length >= 2 && (
            <div style={{ ...css.card, padding: 16, marginBottom: 12 }}>
              <p style={{ color: P.dim, fontSize: 12, margin: "0 0 8px" }}>Response frequency over time (bold line = trend)</p>
              {/* Filter */}
              <div style={{ display: "flex", gap: 4, marginBottom: 12, flexWrap: "wrap" }}>
                <button onClick={() => setSeriesFilter("all")} style={{ ...css_chip(seriesFilter === "all", P.warm) }}>All</button>
                {RESPONSES.map(r => (
                  <button key={r.id} onClick={() => setSeriesFilter(r.id)} style={{ ...css_chip(seriesFilter === r.id, r.c) }}>{r.icon} {r.label}</button>
                ))}
              </div>
              {filteredSeries.map(s => {
                const hasData = s.counts.some(c => c > 0);
                if (!hasData) return null;
                return (
                  <div key={s.id} style={{ marginBottom: 10 }}>
                    <div style={{ display: "flex", alignItems: "center", gap: 6, marginBottom: 2 }}>
                      <span style={{ fontSize: 12, color: s.c }}>{s.icon}</span>
                      <span style={{ fontSize: 11, color: s.c, fontWeight: 500 }}>{s.label}</span>
                      <span style={{ fontSize: 10, color: P.dim }}>({s.counts.reduce((a, b) => a + b, 0)} total)</span>
                    </div>
                    <SmallMultiple data={s} maxY={globalMaxDaily} />
                  </div>
                );
              })}
              {/* X axis labels */}
              <div style={{ display: "flex", justifyContent: "space-between", marginTop: 2 }}>
                <span style={{ color: P.dimmer, fontSize: 9 }}>{fmtKey(groups[0].key)}</span>
                {groups.length > 2 && <span style={{ color: P.dimmer, fontSize: 9 }}>{fmtKey(groups[Math.floor(groups.length / 2)].key)}</span>}
                <span style={{ color: P.dimmer, fontSize: 9 }}>{fmtKey(groups[groups.length - 1].key)}</span>
              </div>
            </div>
          )}

          {/* Stats */}
          <div style={{ display: "flex", gap: 8, marginBottom: 12 }}>
            <Stat n={fil.length} l="interactions" />
            <Stat n={fil.filter(e => e.response === "positive" || e.response === "neutral").length} l="positive / neutral" />
            <Stat n={fil.filter(e => e.response === "rejection" || e.response === "escalation").length} l="rejections" />
          </div>

          {/* Entries with snapshot markers interleaved */}
          {(() => {
            const snapsByDate = {};
            snaps.forEach(s => {
              const d = new Date(s.date);
              const k = `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, "0")}-${String(d.getDate()).padStart(2, "0")}`;
              snapsByDate[k] = s;
            });
            const items = fil.slice(0, 60).map(e => ({ type: "entry", data: e, date: new Date(e.date) }));
            // Insert snap markers
            snaps.forEach(s => {
              const sd = new Date(s.date);
              if (sd.getTime() >= cut) items.push({ type: "snap", data: s, date: sd });
            });
            items.sort((a, b) => b.date - a.date);
            return items.map((item, i) => {
              if (item.type === "entry") return <EntryRow key={item.data.id} entry={item.data} onClick={() => openEntry(item.data)} />;
              return (
                <div key={"snap-" + item.data.id} style={{ display: "flex", alignItems: "center", gap: 8, padding: "8px 12px", margin: "4px 0", borderLeft: `3px solid ${P.purple}`, background: P.card2, borderRadius: "0 8px 8px 0" }}>
                  <span style={{ fontSize: 13 }}>ğŸ“Š</span>
                  <div style={{ flex: 1 }}>
                    <span style={{ color: P.purple, fontSize: 11, fontWeight: 500 }}>Progress snapshot</span>
                    <span style={{ color: P.dim, fontSize: 10, marginLeft: 6 }}>{fmtShort(item.data.date)}</span>
                  </div>
                </div>
              );
            });
          })()}
          {fil.length > 60 && <p style={{ color: P.dim, fontSize: 12, textAlign: "center", padding: 12 }}>Showing 60 of {fil.length}</p>}
        </>
      )}
    </div>
  );
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  PATTERNS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function Patterns({ entries, mode, setMode }) {
  const aPats = useMemo(() => {
    const m = {};
    ACTIONS.forEach(a => { m[a.id] = { total: 0 }; RESPONSES.forEach(r => { m[a.id][r.id] = 0; }); });
    entries.forEach(e => { if (m[e.action]) { m[e.action].total++; m[e.action][e.response]++; } });
    return m;
  }, [entries]);

  const cPats = useMemo(() => {
    const m = {};
    entries.forEach(e => {
      (e.contexts || []).forEach(c => {
        if (!m[c]) { m[c] = { total: 0 }; RESPONSES.forEach(r => { m[c][r.id] = 0; }); }
        m[c].total++; m[c][e.response]++;
      });
    });
    return m;
  }, [entries]);

  const ranked = ACTIONS.map(a => {
    const p = aPats[a.id]; if (p.total < 3) return null;
    const pos = ((p.positive + p.neutral) / p.total) * 100;
    return { ...a, pos, total: p.total };
  }).filter(Boolean).sort((a, b) => b.pos - a.pos);

  if (entries.length < 10) return (
    <div style={{ textAlign: "center", padding: "48px 16px" }}>
      <p style={{ color: P.text, fontSize: 16, marginBottom: 8 }}>Building your patternsâ€¦</p>
      <p style={{ color: P.dim, fontSize: 14 }}>Log at least 10 interactions to start seeing patterns. You have {entries.length}.</p>
      <div style={{ margin: "20px auto", maxWidth: 240 }}>
        <div style={{ height: 6, background: P.border, borderRadius: 3, overflow: "hidden" }}>
          <div style={{ height: "100%", width: `${(entries.length / 10) * 100}%`, background: `linear-gradient(90deg, ${P.warm}, ${P.green})`, borderRadius: 3 }} />
        </div>
        <p style={{ color: P.dim, fontSize: 11, marginTop: 6 }}>{entries.length}/10</p>
      </div>
    </div>
  );

  return (
    <div>
      <Tabs items={["By Action", "By Context", "Insights"]} active={mode === "action" ? "By Action" : mode === "context" ? "By Context" : "Insights"} onPick={v => setMode(v === "By Action" ? "action" : v === "By Context" ? "context" : "insights")} />

      {mode === "action" && (
        <div>
          <p style={{ color: P.dim, fontSize: 13, marginBottom: 14 }}>How your stepchild responds to each type of action.</p>
          {/* Legend */}
          <div style={{ display: "flex", gap: 8, marginBottom: 12, flexWrap: "wrap" }}>
            {[...RESPONSES].reverse().map(r => <span key={r.id} style={{ fontSize: 10, color: r.c }}>{r.icon} {r.label}</span>)}
          </div>
          {ACTIONS.map(a => {
            const p = aPats[a.id]; if (p.total === 0) return null;
            const reversed = [...RESPONSES].reverse();
            return (
              <div key={a.id} style={{ ...css.card, padding: 14, marginBottom: 8 }}>
                <div style={{ display: "flex", justifyContent: "space-between", marginBottom: 8 }}>
                  <span style={{ color: a.c, fontSize: 13 }}>{a.icon} {a.label}</span>
                  <span style={{ color: P.dim, fontSize: 11 }}>{p.total} logged</span>
                </div>
                <div style={{ display: "flex", height: 20, borderRadius: 5, overflow: "hidden" }}>
                  {reversed.map(r => {
                    const pct = (p[r.id] / p.total) * 100;
                    if (pct === 0) return null;
                    return <div key={r.id} style={{ width: `${pct}%`, background: r.c + "88", display: "flex", alignItems: "center", justifyContent: "center" }}>
                      {pct > 18 && <span style={{ fontSize: 9, color: "#fff" }}>{Math.round(pct)}%</span>}
                    </div>;
                  })}
                </div>
                <div style={{ display: "flex", gap: 8, marginTop: 6, flexWrap: "wrap" }}>
                  {reversed.map(r => { const pct = (p[r.id] / p.total) * 100; if (pct === 0) return null; return <span key={r.id} style={{ color: r.c, fontSize: 10 }}>{r.icon} {Math.round(pct)}%</span>; })}
                </div>
              </div>
            );
          })}
        </div>
      )}

      {mode === "context" && (
        <div>
          <p style={{ color: P.dim, fontSize: 13, marginBottom: 14 }}>Which contexts produce which responses.</p>
          {Object.entries(cPats).filter(([, v]) => v.total >= 2).sort(([, a], [, b]) => b.total - a.total).map(([ctx, data]) => (
            <div key={ctx} style={{ ...css.card, padding: 14, marginBottom: 8 }}>
              <div style={{ display: "flex", justifyContent: "space-between", marginBottom: 8 }}>
                <span style={{ color: P.text, fontSize: 13 }}>{ctx}</span>
                <span style={{ color: P.dim, fontSize: 11 }}>{data.total}Ã—</span>
              </div>
              <div style={{ display: "flex", height: 16, borderRadius: 5, overflow: "hidden" }}>
                {[...RESPONSES].reverse().map(r => { const pct = (data[r.id] / data.total) * 100; if (pct === 0) return null; return <div key={r.id} style={{ width: `${pct}%`, background: r.c + "88" }} />; })}
              </div>
            </div>
          ))}
          {Object.keys(cPats).filter(k => cPats[k].total >= 2).length === 0 && <p style={{ color: P.dim, fontSize: 13 }}>Tag contexts on entries to see patterns here.</p>}
        </div>
      )}

      {mode === "insights" && (
        <div>
          {ranked.length > 0 && (
            <div style={{ ...css.card, padding: 16, marginBottom: 10 }}>
              <div style={{ color: P.green, fontSize: 13, fontWeight: 500, marginBottom: 6 }}>ğŸŒ± Most effective approach</div>
              <p style={{ color: P.text, fontSize: 14, margin: 0, lineHeight: 1.6 }}>
                <strong>{ranked[0].icon} {ranked[0].label}</strong> produces a positive or neutral response {Math.round(ranked[0].pos)}% of the time ({ranked[0].total} interactions).
              </p>
            </div>
          )}
          {ranked.length > 1 && ranked[ranked.length - 1].pos < 40 && (
            <div style={{ ...css.card, padding: 16, marginBottom: 10 }}>
              <div style={{ color: P.rose, fontSize: 13, fontWeight: 500, marginBottom: 6 }}>âš¡ Most friction</div>
              <p style={{ color: P.text, fontSize: 14, margin: 0, lineHeight: 1.6 }}>
                <strong>{ranked[ranked.length - 1].icon} {ranked[ranked.length - 1].label}</strong> tends to produce more resistance ({Math.round(100 - ranked[ranked.length - 1].pos)}% negative).
              </p>
            </div>
          )}
          {entries.length >= 20 && (() => {
            const h = Math.floor(entries.length / 2);
            const rAvg = entries.slice(0, h).reduce((s, e) => s + (RESPONSES.find(r => r.id === e.response)?.score ?? 2), 0) / h;
            const oAvg = entries.slice(h).reduce((s, e) => s + (RESPONSES.find(r => r.id === e.response)?.score ?? 2), 0) / (entries.length - h);
            const d = rAvg - oAvg;
            return (
              <div style={{ ...css.card, padding: 16, marginBottom: 10 }}>
                <div style={{ color: d > 0.3 ? P.green : d < -0.3 ? P.rose : P.blue, fontSize: 13, fontWeight: 500, marginBottom: 6 }}>
                  {d > 0.3 ? "ğŸ“ˆ Positive trend" : d < -0.3 ? "ğŸ“‰ Difficult stretch" : "â” Steady state"}
                </div>
                <p style={{ color: P.text, fontSize: 14, margin: 0, lineHeight: 1.6 }}>
                  {d > 0.3 ? "Recent interactions are trending more positively. Keep going â€” this is real progress."
                   : d < -0.3 ? "Recent interactions have been harder. This is normal â€” stepfamily relationships aren't linear. A difficult stretch doesn't erase progress."
                   : "Responses have been consistent. In stepfamily dynamics, stability is itself a form of progress."}
                </p>
              </div>
            );
          })()}
          {entries.length < 20 && (
            <div style={{ ...css.card, padding: 16 }}>
              <div style={{ color: P.blue, fontSize: 13, fontWeight: 500, marginBottom: 6 }}>ğŸ“Š More data needed</div>
              <p style={{ color: P.muted, fontSize: 13, margin: 0 }}>Trend analysis needs ~20 entries. You have {entries.length}.</p>
            </div>
          )}
        </div>
      )}
    </div>
  );
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  PERSPECTIVE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function Perspective({ entries, openCard }) {
  return (
    <div>
      <p style={{ color: P.muted, fontSize: 14, marginBottom: 16 }}>
        Research-backed reframes. Not platitudes â€” real perspectives from research and adult stepchildren looking back.
      </p>
      {CARDS.map((c, i) => (
        <button key={i} onClick={() => openCard(c)} style={{ ...css.card, padding: 16, marginBottom: 8, width: "100%", textAlign: "left", cursor: "pointer", border: `1px solid ${P.border}`, fontFamily: "inherit" }}>
          <div style={{ color: P.text, fontWeight: 500, marginBottom: 4, fontSize: 14 }}>{c.title}</div>
          <div style={{ color: P.dim, fontSize: 13, lineHeight: 1.5 }}>{c.body.slice(0, 110)}â€¦</div>
          {c.quote && <div style={{ color: P.warm, fontSize: 11, marginTop: 6, fontStyle: "italic" }}>Includes firsthand account â—‡</div>}
        </button>
      ))}
    </div>
  );
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  PARTNER â€” Communication Tips & Share
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function Partner({ entries, profile, snaps }) {
  const [tab, setTab] = useState("tips");
  const [expandedTip, setExpandedTip] = useState(null);
  const [copied, setCopied] = useState(false);

  const generateReport = () => {
    const month = entries.filter(e => daysAgo(e.date) <= 30);
    if (month.length === 0) return null;
    const total = month.length;
    const pos = month.filter(e => e.response === "positive" || e.response === "neutral").length;
    const rej = month.filter(e => e.response === "rejection" || e.response === "escalation").length;
    const pct = Math.round((pos / total) * 100);
    const actionCounts = {};
    ACTIONS.forEach(a => { actionCounts[a.id] = { pos: 0, total: 0 }; });
    month.forEach(e => {
      if (actionCounts[e.action]) {
        actionCounts[e.action].total++;
        if (e.response === "positive" || e.response === "neutral") actionCounts[e.action].pos++;
      }
    });
    let bestAction = null, bestPct = 0;
    Object.entries(actionCounts).forEach(([id, d]) => {
      if (d.total >= 3) {
        const p = d.pos / d.total;
        if (p > bestPct) { bestPct = p; bestAction = ACTIONS.find(a => a.id === id); }
      }
    });
    const lines = [
      "Monthly Update from Steadfast",
      String.fromCharCode(9472).repeat(29),
      "",
      `This month, I logged ${total} interactions with your child.`,
      "",
      `${pct}% of responses were positive or neutral.`,
      `${rej} interactions involved active rejection or escalation.`,
      "",
    ];
    if (bestAction) {
      lines.push(`What seems to work best: "${bestAction.label}" \u2014 ${Math.round(bestPct * 100)}% positive response rate.`);
      lines.push("");
    }
    lines.push("What I need from you:");
    lines.push("\u2022 Acknowledge what you see me doing, even small things");
    lines.push("\u2022 Back me up in the moment, even with just a word");
    lines.push("\u2022 Remind me that my effort matters when I can't see it");
    lines.push("");
    lines.push("This isn't a complaint. It's me showing you what I'm tracking so we can be a team in this.");
    lines.push("");
    lines.push("\u2014 Sent from Steadfast");
    return lines.join("\n");
  };

  const report = generateReport();

  const copyReport = () => {
    if (!report) return;
    navigator.clipboard.writeText(report).then(() => {
      setCopied(true); setTimeout(() => setCopied(false), 2000);
    }).catch(() => {
      const ta = document.createElement("textarea");
      ta.value = report; document.body.appendChild(ta); ta.select();
      document.execCommand("copy"); document.body.removeChild(ta);
      setCopied(true); setTimeout(() => setCopied(false), 2000);
    });
  };

  return (
    <div>
      <Tabs items={["Tips", "Share", "Alienation"]} active={tab === "tips" ? "Tips" : tab === "share" ? "Share" : "Alienation"} onPick={v => setTab(v === "Tips" ? "tips" : v === "Share" ? "share" : "alienation")} />

      {tab === "tips" && (
        <div>
          <p style={{ color: P.muted, fontSize: 14, marginBottom: 16, lineHeight: 1.6 }}>
            How to talk to your partner about what you're going through â€” without it turning into a fight.
          </p>
          {PARTNER_TIPS.map((t, i) => (
            <button key={i} onClick={() => setExpandedTip(expandedTip === i ? null : i)} style={{ ...css.card, padding: 16, marginBottom: 8, width: "100%", textAlign: "left", cursor: "pointer", border: `1px solid ${expandedTip === i ? P.warm + "44" : P.border}`, fontFamily: "inherit" }}>
              <div style={{ display: "flex", justifyContent: "space-between", alignItems: "center" }}>
                <div style={{ color: P.text, fontWeight: 500, fontSize: 14 }}>{t.title}</div>
                <span style={{ color: P.dim, fontSize: 12, transform: expandedTip === i ? "rotate(180deg)" : "none", transition: "transform .2s" }}>{"\u25BE"}</span>
              </div>
              <div style={{ color: P.dim, fontSize: 12, marginTop: 4 }}>{t.situation}</div>
              {expandedTip === i && (
                <div style={{ marginTop: 12 }}>
                  <div style={{ padding: 14, background: P.bg, borderRadius: 10, borderLeft: `3px solid ${P.green}44`, marginBottom: 10 }}>
                    <p style={{ color: P.dim, fontSize: 10, margin: "0 0 6px", textTransform: "uppercase", letterSpacing: "0.05em" }}>Try saying</p>
                    <p style={{ color: P.text, fontSize: 13, margin: 0, lineHeight: 1.6, fontStyle: "italic" }}>{t.tip}</p>
                  </div>
                  <div style={{ padding: 14, background: P.bg, borderRadius: 10, borderLeft: `3px solid ${P.blue}44` }}>
                    <p style={{ color: P.dim, fontSize: 10, margin: "0 0 6px", textTransform: "uppercase", letterSpacing: "0.05em" }}>Why this works</p>
                    <p style={{ color: P.muted, fontSize: 13, margin: 0, lineHeight: 1.6 }}>{t.why}</p>
                  </div>
                </div>
              )}
            </button>
          ))}
        </div>
      )}

      {tab === "share" && (
        <div>
          <p style={{ color: P.muted, fontSize: 14, marginBottom: 16, lineHeight: 1.6 }}>
            Share a monthly summary with your partner. It shows what you've been doing, what's working, and what you need â€” backed by data, not just feelings.
          </p>
          {report ? (
            <div>
              <div style={{ ...css.card, padding: 16, marginBottom: 12 }}>
                <pre style={{ color: P.muted, fontSize: 11, lineHeight: 1.6, margin: 0, whiteSpace: "pre-wrap", wordBreak: "break-word", fontFamily: "inherit" }}>{report}</pre>
              </div>
              <Btn onClick={copyReport} full>{copied ? "Copied!" : "Copy to clipboard"}</Btn>
              <p style={{ color: P.dim, fontSize: 11, marginTop: 10, textAlign: "center" }}>Paste into a message, email, or note to share with your partner.</p>
            </div>
          ) : (
            <div style={{ textAlign: "center", padding: "40px 20px" }}>
              <p style={{ color: P.dim, fontSize: 14 }}>Log some interactions first to generate a report.</p>
            </div>
          )}
        </div>
      )}

      {tab === "alienation" && (
        <div>
          <div style={{ ...css.card, padding: 20, marginBottom: 12, borderLeft: `3px solid ${P.rose}` }}>
            <h3 style={{ color: P.text, fontSize: 16, fontFamily: "Georgia, 'Times New Roman', serif", margin: "0 0 10px" }}>{ALIENATION.title}</h3>
            <p style={{ color: P.muted, fontSize: 13, lineHeight: 1.7, margin: 0 }}>{ALIENATION.intro}</p>
          </div>
          <div style={{ ...css.card, padding: 16, marginBottom: 12 }}>
            <div style={{ color: P.rose, fontSize: 13, fontWeight: 500, marginBottom: 10 }}>Warning signs</div>
            {ALIENATION.signs.map((s, i) => (
              <div key={i} style={{ display: "flex", gap: 8, marginBottom: 8 }}>
                <span style={{ color: P.rose, fontSize: 11, marginTop: 2, flexShrink: 0 }}>{"\u2022"}</span>
                <p style={{ color: P.muted, fontSize: 13, margin: 0, lineHeight: 1.5 }}>{s}</p>
              </div>
            ))}
          </div>
          {ALIENATION.guidance.map((g, i) => (
            <div key={i} style={{ ...css.card, padding: 16, marginBottom: 8 }}>
              <div style={{ color: P.text, fontSize: 14, fontWeight: 500, marginBottom: 6 }}>{g.title}</div>
              <p style={{ color: P.muted, fontSize: 13, lineHeight: 1.6, margin: 0 }}>{g.text}</p>
            </div>
          ))}
          <div style={{ ...css.card, padding: 16, marginTop: 4, background: `${P.card2}88`, borderLeft: `3px solid ${P.blue}44` }}>
            <p style={{ color: P.dim, fontSize: 12, margin: 0, lineHeight: 1.6 }}>{ALIENATION.note}</p>
          </div>
        </div>
      )}
    </div>
  );
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  BENCHMARK
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function Benchmark({ profile, snaps, entries, openSnap, onDeleteSnap }) {
  if (!profile) return null;
  const age = BENCH.ages[profile.childAge];
  const cust = BENCH.custody[profile.custody];
  const loy = BENCH.loyalty[profile.loyaltyConflict];

  return (
    <div>
      <SectionTitle>Your Situation</SectionTitle>
      <div style={{ display: "grid", gridTemplateColumns: "1fr 1fr", gap: 8, marginBottom: 16 }}>
        <BenchItem label="Child's age" value={profile.childAge + " yrs"} />
        <BenchItem label="Custody" value={profile.custody} />
        <BenchItem label="Loyalty conflict" value={profile.loyaltyConflict} />
        <BenchItem label="Time in role" value={profile.yearsInRole + " yr" + (profile.yearsInRole !== "1" ? "s" : "")} />
      </div>

      {age && (
        <div style={{ ...css.card, padding: 16, marginBottom: 10 }}>
          <div style={{ color: P.warm, fontSize: 13, fontWeight: 500, marginBottom: 6 }}>Typical integration timeline</div>
          <div style={{ color: P.text, fontSize: 20, fontFamily: "Georgia, 'Times New Roman', serif", fontWeight: 500, marginBottom: 8 }}>{age.t}</div>
          <p style={{ color: P.muted, fontSize: 13, margin: 0, lineHeight: 1.6 }}>{age.note}</p>
          <div style={{ marginTop: 12, padding: 12, background: P.bg, borderRadius: 8 }}>
            <p style={{ color: P.blue, fontSize: 12, margin: 0 }}>
              You're ~{profile.yearsInRole} year{profile.yearsInRole !== "1" ? "s" : ""} in.
              {parseInt(profile.yearsInRole) < 4 ? " Still early â€” fastest documented full integration was 4 years." : ""}
              {parseInt(profile.yearsInRole) >= 7 ? " Your sustained presence matters, regardless of where the relationship has settled." : ""}
            </p>
          </div>
        </div>
      )}

      {cust && <div style={{ ...css.card, padding: 16, marginBottom: 10 }}><div style={{ color: P.warm, fontSize: 13, fontWeight: 500, marginBottom: 6 }}>Custody impact</div><p style={{ color: P.muted, fontSize: 13, margin: 0, lineHeight: 1.6 }}>{cust}</p></div>}
      {loy && <div style={{ ...css.card, padding: 16, marginBottom: 10 }}><div style={{ color: P.warm, fontSize: 13, fontWeight: 500, marginBottom: 6 }}>Loyalty dynamics</div><p style={{ color: P.muted, fontSize: 13, margin: 0, lineHeight: 1.6 }}>{loy}</p></div>}

      {/* Outcomes */}
      <div style={{ ...css.card, padding: 16, marginBottom: 10 }}>
        <div style={{ color: P.warm, fontSize: 13, fontWeight: 500, marginBottom: 10 }}>Realistic outcome spectrum</div>
        <p style={{ color: P.dim, fontSize: 12, marginBottom: 10 }}>All of these are valid success states.</p>
        {BENCH.outcomes.map((o, i) => (
          <div key={i} style={{ padding: "10px 12px", borderLeft: `3px solid ${o.c}`, marginBottom: 6, background: P.bg, borderRadius: "0 8px 8px 0" }}>
            <div style={{ display: "flex", justifyContent: "space-between" }}>
              <span style={{ color: P.text, fontSize: 13, fontWeight: 500 }}>{o.l}</span>
              <span style={{ color: P.dim, fontSize: 11 }}>{o.p}</span>
            </div>
            <p style={{ color: P.dim, fontSize: 12, margin: "3px 0 0" }}>{o.d}</p>
          </div>
        ))}
      </div>

      {/* First vs Latest summary */}
      {snaps.length >= 2 && (() => {
        const first = snaps[0];
        const last = snaps[snaps.length - 1];
        const improved = SNAP_Q.filter(q => (last.answers?.[q.id] ?? 0) > (first.answers?.[q.id] ?? 0)).length;
        const declined = SNAP_Q.filter(q => (last.answers?.[q.id] ?? 0) < (first.answers?.[q.id] ?? 0)).length;
        const same = SNAP_Q.length - improved - declined;
        const daysBetween = Math.round((new Date(last.date) - new Date(first.date)) / 86400000);
        return (
          <div style={{ ...css.card, padding: 18, marginBottom: 10, borderLeft: `3px solid ${improved > declined ? P.green : improved < declined ? P.rose : P.blue}` }}>
            <div style={{ color: P.text, fontSize: 15, fontFamily: "Georgia, 'Times New Roman', serif", fontWeight: 500, marginBottom: 8 }}>
              {improved > declined ? "Things are moving" : improved < declined ? "A harder stretch" : "Holding steady"}
            </div>
            <p style={{ color: P.muted, fontSize: 13, margin: "0 0 10px", lineHeight: 1.5 }}>
              Over {daysBetween} days and {snaps.length} snapshots:
            </p>
            <div style={{ display: "flex", gap: 12 }}>
              {improved > 0 && <div style={{ flex: 1, padding: 10, background: P.bg, borderRadius: 8, textAlign: "center" }}>
                <div style={{ color: P.green, fontSize: 20, fontWeight: 600 }}>{improved}</div>
                <div style={{ color: P.dim, fontSize: 10 }}>improved</div>
              </div>}
              {same > 0 && <div style={{ flex: 1, padding: 10, background: P.bg, borderRadius: 8, textAlign: "center" }}>
                <div style={{ color: P.blue, fontSize: 20, fontWeight: 600 }}>{same}</div>
                <div style={{ color: P.dim, fontSize: 10 }}>steady</div>
              </div>}
              {declined > 0 && <div style={{ flex: 1, padding: 10, background: P.bg, borderRadius: 8, textAlign: "center" }}>
                <div style={{ color: P.rose, fontSize: 20, fontWeight: 600 }}>{declined}</div>
                <div style={{ color: P.dim, fontSize: 10 }}>harder</div>
              </div>}
            </div>
          </div>
        );
      })()}

      {/* Snapshot trend charts â€” one per question */}
      {snaps.length >= 2 && (
        <div style={{ ...css.card, padding: 16, marginBottom: 10 }}>
          <div style={{ color: P.warm, fontSize: 13, fontWeight: 500, marginBottom: 12 }}>Progress over time</div>
          {SNAP_Q.map(q => {
            const dataPoints = snaps.map(s => ({ val: s.answers?.[q.id] ?? null, date: s.date })).filter(d => d.val !== null);
            if (dataPoints.length < 2) return null;
            const vals = dataPoints.map(d => d.val);
            const max = q.s.length - 1;
            const first = vals[0];
            const latest = vals[vals.length - 1];
            const delta = latest - first;
            const deltaColor = delta > 0 ? P.green : delta < 0 ? P.red : P.dim;
            const w = 260, h = 50;
            const xStep = (w - 8) / (vals.length - 1);
            const pts = vals.map((v, i) => ({ x: 4 + i * xStep, y: h - 6 - (v / max) * (h - 12) }));
            const pathD = pts.map((p, i) => `${i === 0 ? "M" : "L"}${p.x},${p.y}`).join(" ");
            // Area fill
            const areaD = pathD + ` L${pts[pts.length - 1].x},${h - 6} L${pts[0].x},${h - 6} Z`;
            return (
              <div key={q.id} style={{ marginBottom: 16 }}>
                <div style={{ color: P.muted, fontSize: 12, marginBottom: 2, lineHeight: 1.4 }}>{q.q}</div>
                <div style={{ display: "flex", justifyContent: "space-between", alignItems: "center", marginBottom: 4 }}>
                  <span style={{ color: P.dim, fontSize: 10 }}>{q.s[first]}</span>
                  <span style={{ color: deltaColor, fontSize: 11, fontWeight: 500 }}>
                    {delta > 0 ? "\u2192 " : delta < 0 ? "\u2192 " : ""}{q.s[latest]} {delta > 0 ? "\u2191" : delta < 0 ? "\u2193" : "="}
                  </span>
                </div>
                <svg viewBox={`0 0 ${w} ${h}`} style={{ width: "100%", height: h, display: "block" }}>
                  <line x1="4" y1={h - 6} x2={w - 4} y2={h - 6} stroke={P.border} strokeWidth="0.5" />
                  <path d={areaD} fill={P.warm + "11"} />
                  <path d={pathD} fill="none" stroke={P.warm} strokeWidth="2" />
                  {pts.map((p, i) => (
                    <g key={i}>
                      <circle cx={p.x} cy={p.y} r={i === 0 || i === pts.length - 1 ? 4 : 2.5} fill={i === pts.length - 1 ? P.warm : i === 0 ? P.dim : P.dim} />
                    </g>
                  ))}
                </svg>
                <div style={{ display: "flex", justifyContent: "space-between" }}>
                  <span style={{ color: P.dimmer, fontSize: 8 }}>{fmtShort(dataPoints[0].date)}</span>
                  <span style={{ color: P.dimmer, fontSize: 8 }}>{fmtShort(dataPoints[dataPoints.length - 1].date)}</span>
                </div>
              </div>
            );
          })}
        </div>
      )}

      {/* Individual snapshots â€” compact list */}
      {snaps.length > 0 && (
        <div style={{ ...css.card, padding: 16, marginBottom: 10 }}>
          <div style={{ color: P.warm, fontSize: 13, fontWeight: 500, marginBottom: 10 }}>All snapshots ({snaps.length})</div>
          {[...snaps].reverse().map(s => (
            <div key={s.id} style={{ padding: "8px 0", borderBottom: `1px solid ${P.border}`, display: "flex", justifyContent: "space-between", alignItems: "center" }}>
              <div>
                <span style={{ color: P.text, fontSize: 12 }}>{fmtDate(s.date)}</span>
                <span style={{ color: P.dim, fontSize: 10, marginLeft: 8 }}>
                  {SNAP_Q.slice(0, 2).map(q => s.answers?.[q.id] !== undefined ? q.s[s.answers[q.id]] : "").filter(Boolean).join(" \u00B7 ")}
                </span>
              </div>
              <button onClick={() => onDeleteSnap(s.id)} style={{ background: "none", border: "none", color: P.dim, cursor: "pointer", fontSize: 11, padding: "4px 8px" }}>{"\u2715"}</button>
            </div>
          ))}
        </div>
      )}

      <Btn onClick={openSnap} full>Take a Progress Snapshot</Btn>
    </div>
  );
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  ENTRY MODAL
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function EntryModal({ entry, onSave, onDelete, onClose }) {
  const isEdit = !!entry;
  const [action, setAction] = useState(entry?.action || "");
  const [response, setResponse] = useState(entry?.response || "");
  const [note, setNote] = useState(entry?.note || "");
  const [ctxs, setCtxs] = useState(entry?.contexts || []);
  const [date, setDate] = useState(entry?.date?.slice(0, 10) || new Date().toISOString().slice(0, 10));
  const [confirmDel, setConfirmDel] = useState(false);
  const [photo, setPhoto] = useState(entry?.photo || null);
  const fileRef = useRef(null);

  const toggle = (c) => setCtxs(p => p.includes(c) ? p.filter(x => x !== c) : [...p, c]);
  const valid = action && response;

  const handlePhoto = (e) => {
    const file = e.target.files[0];
    if (!file) return;
    // Resize to max 800px to keep IndexedDB manageable
    const reader = new FileReader();
    reader.onload = (ev) => {
      const img = new Image();
      img.onload = () => {
        const max = 800;
        let w = img.width, h = img.height;
        if (w > max || h > max) {
          if (w > h) { h = Math.round(h * max / w); w = max; }
          else { w = Math.round(w * max / h); h = max; }
        }
        const canvas = document.createElement("canvas");
        canvas.width = w; canvas.height = h;
        canvas.getContext("2d").drawImage(img, 0, 0, w, h);
        setPhoto(canvas.toDataURL("image/jpeg", 0.7));
      };
      img.src = ev.target.result;
    };
    reader.readAsDataURL(file);
  };

  return (
    <Modal onClose={onClose} title={isEdit ? "Edit Interaction" : "Log an Interaction"}>
      <label style={css.label}>Date</label>
      <input type="date" value={date} onChange={e => setDate(e.target.value)} style={css.dateIn} />

      <label style={css.label}>What did you do?</label>
      <div style={css.chips}>
        {ACTIONS.map(a => <Chip key={a.id} active={action === a.id} color={a.c} onClick={() => setAction(a.id)}>{a.icon} {a.label}</Chip>)}
      </div>

      <label style={css.label}>How did they respond?</label>
      <div style={css.chips}>
        {RESPONSES.map(r => <Chip key={r.id} active={response === r.id} color={r.c} onClick={() => setResponse(r.id)}>{r.icon} {r.label}</Chip>)}
      </div>

      <label style={css.label}>Context <span style={{ color: P.dim, fontWeight: 400 }}>(optional)</span></label>
      <div style={css.chips}>
        {CONTEXTS.map(c => <Chip key={c} small active={ctxs.includes(c)} color={P.warm} onClick={() => toggle(c)}>{c}</Chip>)}
      </div>

      <label style={css.label}>Photo <span style={{ color: P.dim, fontWeight: 400 }}>(optional)</span></label>
      {photo ? (
        <div style={{ marginBottom: 14, position: "relative", display: "inline-block" }}>
          <img src={photo} alt="Attached" style={{ width: "100%", maxWidth: 220, borderRadius: 10, display: "block", border: `1px solid ${P.border}` }} />
          <button onClick={() => { setPhoto(null); if (fileRef.current) fileRef.current.value = ""; }} style={{ position: "absolute", top: 6, right: 6, background: "rgba(0,0,0,0.7)", border: "none", color: "#fff", borderRadius: "50%", width: 24, height: 24, fontSize: 13, cursor: "pointer", display: "flex", alignItems: "center", justifyContent: "center" }}>âœ•</button>
        </div>
      ) : (
        <button onClick={() => fileRef.current?.click()} style={{ display: "flex", alignItems: "center", gap: 8, padding: "10px 14px", borderRadius: 9, border: `1px dashed ${P.border2}`, background: "transparent", color: P.dim, cursor: "pointer", fontSize: 13, fontFamily: "inherit", marginBottom: 14, width: "100%" }}>
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="1.5"><rect x="3" y="3" width="18" height="18" rx="3"/><circle cx="8.5" cy="8.5" r="1.5"/><path d="M21 15l-5-5L5 21"/></svg>
          Add a photo
        </button>
      )}
      <input ref={fileRef} type="file" accept="image/*" onChange={handlePhoto} style={{ display: "none" }} />

      <label style={css.label}>Notes <span style={{ color: P.dim, fontWeight: 400 }}>(optional)</span></label>
      <textarea value={note} onChange={e => setNote(e.target.value)} placeholder="What happened? How did it feel?" style={css.textarea} rows={3} />

      <Btn onClick={() => { if (valid) onSave({ id: entry?.id || uid(), date: new Date(date + "T12:00:00").toISOString(), action, response, note, contexts: ctxs, photo: photo || undefined }); }} full disabled={!valid} style={{ marginTop: 16 }}>{isEdit ? "Update" : "Save"}</Btn>

      {isEdit && onDelete && (
        !confirmDel
          ? <button onClick={() => setConfirmDel(true)} style={{ ...css.textBtn, color: P.dim, marginTop: 8 }}>Delete this entry</button>
          : <div style={{ textAlign: "center", marginTop: 8 }}>
              <p style={{ color: P.red, fontSize: 12, margin: "0 0 6px" }}>Are you sure?</p>
              <button onClick={() => onDelete(entry.id)} style={{ ...css.textBtn, color: P.red }}>Yes, delete</button>
              <button onClick={() => setConfirmDel(false)} style={{ ...css.textBtn, color: P.dim, marginLeft: 12 }}>Cancel</button>
            </div>
      )}
    </Modal>
  );
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  CARD (PERSPECTIVE) MODAL
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function CardModal({ card, onClose }) {
  return (
    <Modal onClose={onClose} title={`â—‡ ${card.title}`} titleColor={P.warm}>
      <p style={{ color: "#D1D5DB", fontSize: 15, lineHeight: 1.7 }}>{card.body}</p>
      {card.src && <p style={{ color: P.blue, fontSize: 12, fontStyle: "italic", marginTop: 12 }}>Source: {card.src}</p>}
      {card.quote && (
        <div style={{ background: P.bg, borderRadius: 12, padding: 16, marginTop: 16, borderLeft: `3px solid ${P.warm}44` }}>
          <p style={{ color: P.text, fontSize: 14, lineHeight: 1.7, fontStyle: "italic", margin: 0 }}>{card.quote}</p>
          {card.who && <p style={{ color: P.warm, fontSize: 12, marginTop: 8, marginBottom: 0 }}>â€” {card.who}</p>}
        </div>
      )}
      <div style={{ marginTop: 20, padding: 14, background: `${P.card2}88`, borderRadius: 10, borderLeft: `3px solid ${P.green}33` }}>
        <p style={{ color: P.dim, fontSize: 12, margin: 0, lineHeight: 1.6 }}>
          This perspective isn't about dismissing your pain. What you're feeling is real. This is about separating what's happening from what it means â€” because in stepfamily dynamics, those are often very different things.
        </p>
      </div>
    </Modal>
  );
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  SNAPSHOT MODAL
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function SnapModal({ snaps, onSave, onClose }) {
  const [ans, setAns] = useState({});
  const done = SNAP_Q.every(q => ans[q.id] !== undefined);

  return (
    <Modal onClose={onClose} title="Monthly Check-in">
      <p style={{ color: P.dim, fontSize: 13, marginBottom: 16 }}>Answer honestly â€” this is for you. These snapshots become valuable when you compare them over time.</p>
      {SNAP_Q.map(q => (
        <div key={q.id} style={{ marginBottom: 18 }}>
          <label style={{ ...css.label, fontSize: 13 }}>{q.q}</label>
          <div style={css.chips}>
            {q.s.map((s, i) => <Chip key={i} small active={ans[q.id] === i} color={P.warm} onClick={() => setAns(p => ({ ...p, [q.id]: i }))}>{s}</Chip>)}
          </div>
        </div>
      ))}
      <Btn onClick={() => { if (done) onSave({ id: uid(), date: new Date().toISOString(), answers: ans }); }} full disabled={!done}>Save Snapshot</Btn>
    </Modal>
  );
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  SETTINGS MODAL
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function SettingsModal({ onClose, onExport, onImport, onRedo }) {
  const ref = useRef(null);
  const [showPrivacy, setShowPrivacy] = useState(false);
  return (
    <Modal onClose={onClose} title="Settings" small>
      <p style={{ color: P.dim, fontSize: 13, marginBottom: 14 }}>Your data lives on this device only. Back it up to keep it safe.</p>
      <Btn onClick={onExport} full>Export Data Backup</Btn>
      <Btn onClick={() => ref.current?.click()} full secondary style={{ marginTop: 8 }}>Import Data Backup</Btn>
      <input ref={ref} type="file" accept=".json" onChange={onImport} style={{ display: "none" }} />
      <hr style={{ border: "none", borderTop: `1px solid ${P.border}`, margin: "20px 0 14px" }} />
      <Btn onClick={onRedo} full secondary>Redo Onboarding</Btn>
      <hr style={{ border: "none", borderTop: `1px solid ${P.border}`, margin: "20px 0 14px" }} />
      <button onClick={() => setShowPrivacy(p => !p)} style={{ ...css.textBtn, color: P.dim, width: "100%", textAlign: "center", fontSize: 12 }}>
        {showPrivacy ? "Hide" : "Show"} Privacy Policy
      </button>
      {showPrivacy && (
        <div style={{ marginTop: 10, padding: 14, background: P.bg, borderRadius: 10, fontSize: 11, color: P.muted, lineHeight: 1.7 }}>
          <p style={{ fontWeight: 600, color: P.text, marginBottom: 8, fontSize: 12 }}>Privacy Policy</p>
          <p style={{ margin: "0 0 8px" }}>Steadfast stores all data locally on your device using IndexedDB. This includes interaction logs, profile settings, progress snapshots, and any photos you attach.</p>
          <p style={{ margin: "0 0 8px" }}><strong style={{ color: P.text }}>No data is collected, transmitted, or stored on any server.</strong> We have no access to your data. There is no account, no login, no analytics, no tracking, and no cookies.</p>
          <p style={{ margin: "0 0 8px" }}>No external network requests are made. The app uses only system fonts and runs entirely offline after first load.</p>
          <p style={{ margin: "0 0 8px" }}>You can export your data as a JSON file at any time using the Export button above. You can delete all data by clearing your browser's site data for this app.</p>
          <p style={{ margin: "0 0 8px" }}>Photos you attach are resized and stored locally as part of your entry data. They are never uploaded anywhere.</p>
          <p style={{ margin: 0 }}>Contact: [your email here]</p>
        </div>
      )}
    </Modal>
  );
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  ONBOARDING
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function Onboarding({ onDone }) {
  const [step, setStep] = useState(0);
  const [d, setD] = useState({ childAge: "", custody: "", loyaltyConflict: "", yearsInRole: "", currentState: "", startDate: new Date().toISOString() });
  const upd = (k, v) => setD(p => ({ ...p, [k]: v }));

  const steps = [
    { title: "Before we start", sub: "This needs to be said upfront.", content: (
      <div>
        <p style={css.obText}>The path to a functional relationship with a resistant stepchild typically takes <strong style={{ color: P.warm }}>7 to 12 years</strong>. The fastest documented full integration was 4 years. Some families never get there â€” and a stable, respectful distance is a valid outcome.</p>
        <p style={css.obText}>No app will change that timeline. What this tool does is make the invisible visible â€” so you can see whether your efforts are producing change, even when it doesn't feel like it.</p>
        <p style={css.obText}>You're not here because you failed. You're here because you care enough to track what's actually happening.</p>
      </div>
    )},
    { title: "How old is the child?", sub: "At the time your family formed", content: (
      <div style={css.chips}>{Object.keys(BENCH.ages).map(a => <ObBtn key={a} active={d.childAge === a} onClick={() => upd("childAge", a)}>{a} years</ObBtn>)}</div>
    )},
    { title: "Custody arrangement", content: (
      <div style={css.chips}>{["full", "50-50", "weekends", "other"].map(c => <ObBtn key={c} active={d.custody === c} onClick={() => upd("custody", c)}>{c === "full" ? "Full-time" : c === "50-50" ? "50/50" : c === "weekends" ? "Weekends" : "Other"}</ObBtn>)}</div>
    )},
    { title: "Loyalty conflict?", sub: "Does the child seem torn between accepting you and staying loyal to their biological parent?", content: (
      <div style={css.chips}>{["none", "mild", "strong", "unknown"].map(l => <ObBtn key={l} active={d.loyaltyConflict === l} onClick={() => upd("loyaltyConflict", l)}>{l === "none" ? "No visible conflict" : l === "mild" ? "Some tension" : l === "strong" ? "Strong / active" : "I'm not sure"}</ObBtn>)}</div>
    )},
    { title: "How long in this role?", content: (
      <div style={css.chips}>{["< 1", "1", "2-3", "4-6", "7+"].map(y => <ObBtn key={y} active={d.yearsInRole === y} onClick={() => upd("yearsInRole", y)}>{y} yr{y !== "1" && y !== "< 1" ? "s" : ""}</ObBtn>)}</div>
    )},
    { title: "Current relationship state", content: (
      <div style={css.chips}>{["hostile", "avoidant", "tense", "neutral", "warming"].map(s => <ObBtn key={s} active={d.currentState === s} onClick={() => upd("currentState", s)}>{s.charAt(0).toUpperCase() + s.slice(1)}</ObBtn>)}</div>
    )},
    { title: "Your realistic benchmark", content: (() => {
      const age = BENCH.ages[d.childAge];
      return (
        <div>
          {age && <>
            <p style={{ color: P.dim, fontSize: 13 }}>Based on what you've shared, research suggests:</p>
            <p style={{ color: P.text, fontSize: 22, fontFamily: "Georgia, 'Times New Roman', serif", fontWeight: 500, margin: "12px 0" }}>Typical timeline: {age.t}</p>
            <p style={{ color: P.muted, fontSize: 13, lineHeight: 1.6 }}>{age.note}</p>
          </>}
          <div style={{ marginTop: 16, padding: 14, background: `${P.card2}88`, borderRadius: 10, borderLeft: `3px solid ${P.warm}44` }}>
            <p style={{ color: P.text, fontSize: 13, lineHeight: 1.6, margin: 0 }}>
              This tool won't shorten that timeline. It will make the progress within it visible â€” so you don't abandon what's working, and you don't burn out from effort that feels invisible.
            </p>
          </div>
        </div>
      );
    })()},
  ];

  const canGo = step === 0 || step === 6
    || (step === 1 && d.childAge) || (step === 2 && d.custody)
    || (step === 3 && d.loyaltyConflict) || (step === 4 && d.yearsInRole)
    || (step === 5 && d.currentState);

  return (
    <div style={css.root}>
      <div style={{ maxWidth: 500, margin: "0 auto", padding: "40px 20px" }}>
        <div style={{ display: "flex", gap: 4, marginBottom: 28 }}>
          {steps.map((_, i) => <div key={i} style={{ flex: 1, height: 3, borderRadius: 2, background: i <= step ? P.warm : P.border, transition: "background .3s" }} />)}
        </div>
        <h2 style={{ color: P.text, fontSize: 22, fontFamily: "Georgia, 'Times New Roman', serif", margin: "0 0 6px" }}>{steps[step].title}</h2>
        {steps[step].sub && <p style={{ color: P.dim, fontSize: 14, margin: "0 0 16px" }}>{steps[step].sub}</p>}
        {steps[step].content}
        <div style={{ display: "flex", gap: 10, marginTop: 28 }}>
          {step > 0 && <Btn onClick={() => setStep(s => s - 1)} secondary>Back</Btn>}
          <Btn onClick={() => step < steps.length - 1 ? setStep(s => s + 1) : onDone(d)} disabled={!canGo} style={{ flex: 1 }}>
            {step === steps.length - 1 ? "Get Started" : "Continue"}
          </Btn>
        </div>
      </div>
    </div>
  );
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  SHARED UI COMPONENTS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function Modal({ children, onClose, title, titleColor, small }) {
  return (
    <div style={css.overlay} onClick={onClose}>
      <div style={{ ...css.modal, maxWidth: small ? 400 : 600 }} onClick={e => e.stopPropagation()}>
        <div style={css.modalHdr}>
          <h2 style={{ ...css.modalTitle, color: titleColor || P.text }}>{title}</h2>
          <button onClick={onClose} style={css.closeBtn}>âœ•</button>
        </div>
        <div style={{ padding: "16px 20px 24px" }}>{children}</div>
      </div>
    </div>
  );
}

function Btn({ children, onClick, full, secondary, disabled, style }) {
  return (
    <button
      onClick={disabled ? undefined : onClick}
      style={{
        background: secondary ? P.card2 : `linear-gradient(135deg, ${P.warm}, #C4956A)`,
        color: secondary ? P.muted : P.bg,
        border: secondary ? `1px solid ${P.border}` : "none",
        borderRadius: 11,
        padding: "12px 22px",
        fontSize: 14,
        fontWeight: secondary ? 400 : 600,
        cursor: disabled ? "default" : "pointer",
        fontFamily: "inherit",
        width: full ? "100%" : "auto",
        opacity: disabled ? 0.4 : 1,
        transition: "opacity .2s",
        ...style,
      }}
    >
      {children}
    </button>
  );
}

function Chip({ children, active, color, onClick, small }) {
  return (
    <button onClick={onClick} style={{
      padding: small ? "5px 10px" : "8px 14px",
      borderRadius: small ? 7 : 9,
      border: `1px solid ${active ? color : P.border}`,
      background: active ? color + "22" : "transparent",
      color: active ? color : P.dim,
      cursor: "pointer",
      fontSize: small ? 12 : 13,
      fontFamily: "inherit",
      transition: "all .15s",
      whiteSpace: "nowrap",
    }}>
      {children}
    </button>
  );
}

function ObBtn({ children, active, onClick }) {
  return (
    <button onClick={onClick} style={{
      padding: "12px 20px",
      borderRadius: 11,
      border: `1px solid ${active ? P.warm : P.border}`,
      background: active ? P.warm + "18" : "transparent",
      color: active ? P.warm : P.muted,
      cursor: "pointer",
      fontSize: 14,
      fontFamily: "inherit",
      transition: "all .15s",
    }}>
      {children}
    </button>
  );
}

function Stat({ n, l }) {
  return (
    <div style={{ flex: 1, background: P.card, borderRadius: 11, padding: "12px 10px", textAlign: "center", border: `1px solid ${P.border}` }}>
      <div style={{ color: P.text, fontSize: 18, fontFamily: "Georgia, 'Times New Roman', serif", fontWeight: 600 }}>{n}</div>
      <div style={{ color: P.dim, fontSize: 10, marginTop: 2 }}>{l}</div>
    </div>
  );
}

function SectionTitle({ children }) {
  return <div style={{ color: P.dim, fontSize: 11, textTransform: "uppercase", letterSpacing: "0.08em", margin: "16px 0 8px", fontWeight: 500 }}>{children}</div>;
}

function Tabs({ items, active, onPick }) {
  return (
    <div style={{ display: "flex", gap: 3, marginBottom: 14, background: P.card, borderRadius: 9, padding: 3 }}>
      {items.map(i => (
        <button key={i} onClick={() => onPick(i)} style={{
          flex: 1, padding: "8px 10px", borderRadius: 7, border: "none", cursor: "pointer",
          fontSize: 12, fontFamily: "inherit", fontWeight: 500,
          background: active === i ? P.warm + "28" : "transparent",
          color: active === i ? P.warm : P.dim,
          transition: "all .15s",
        }}>
          {i}
        </button>
      ))}
    </div>
  );
}

function EntryRow({ entry, onClick }) {
  const a = ACTIONS.find(x => x.id === entry.action);
  const r = RESPONSES.find(x => x.id === entry.response);
  return (
    <button onClick={onClick} style={{ ...css.card, width: "100%", padding: 12, marginBottom: 6, textAlign: "left", cursor: "pointer", fontFamily: "inherit", border: `1px solid ${P.border}` }}>
      <div style={{ display: "flex", gap: 10 }}>
        {entry.photo && (
          <img src={entry.photo} alt="" style={{ width: 44, height: 44, borderRadius: 7, objectFit: "cover", flexShrink: 0, border: `1px solid ${P.border}` }} />
        )}
        <div style={{ flex: 1, minWidth: 0 }}>
          <div style={{ display: "flex", justifyContent: "space-between", alignItems: "center", marginBottom: entry.note ? 4 : 0, flexWrap: "wrap", gap: 4 }}>
            <span style={{ color: P.dim, fontSize: 11 }}>{fmtShort(entry.date)}</span>
            <div style={{ display: "flex", gap: 5, alignItems: "center" }}>
              {a && <span style={{ padding: "2px 7px", borderRadius: 5, fontSize: 11, background: a.c + "1a", color: a.c }}>{a.icon} {a.label}</span>}
              {r && <span style={{ padding: "2px 7px", borderRadius: 5, fontSize: 11, background: r.c + "1a", color: r.c }}>{r.icon}</span>}
            </div>
          </div>
          {entry.note && <p style={{ color: P.muted, fontSize: 12, margin: 0, lineHeight: 1.4 }}>{entry.note.slice(0, 100)}{entry.note.length > 100 ? "â€¦" : ""}</p>}
          {entry.contexts?.length > 0 && (
            <div style={{ display: "flex", gap: 3, flexWrap: "wrap", marginTop: 4 }}>
              {entry.contexts.map(c => <span key={c} style={{ padding: "1px 5px", borderRadius: 3, fontSize: 9, color: P.dim, background: P.card2 }}>{c}</span>)}
            </div>
          )}
        </div>
      </div>
    </button>
  );
}

function BenchItem({ label, value }) {
  return (
    <div style={{ ...css.card, padding: 11, display: "flex", flexDirection: "column", gap: 3 }}>
      <span style={{ color: P.dim, fontSize: 11 }}>{label}</span>
      <span style={{ color: P.text, fontSize: 13, textTransform: "capitalize" }}>{value}</span>
    </div>
  );
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  STYLES
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const css_chip = (active, color) => ({
  padding: "4px 9px",
  borderRadius: 7,
  border: `1px solid ${active ? color : P.border}`,
  background: active ? color + "22" : "transparent",
  color: active ? color : P.dim,
  cursor: "pointer",
  fontSize: 11,
  fontFamily: "inherit",
  whiteSpace: "nowrap",
});

const css = {
  root: { background: P.bg, minHeight: "100vh", fontFamily: "-apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif", color: "#D1D5DB", WebkitFontSmoothing: "antialiased" },
  shell: { maxWidth: 600, margin: "0 auto", position: "relative" },
  hdr: { padding: "22px 16px 10px", display: "flex", justifyContent: "space-between", alignItems: "flex-start" },
  logo: { fontSize: 26, fontFamily: "Georgia, 'Times New Roman', serif", color: P.text, margin: 0, fontWeight: 500, letterSpacing: "-0.02em" },
  sub: { fontSize: 11, color: P.dim, margin: "2px 0 0", fontStyle: "italic" },
  iconBtn: { background: "none", border: "none", color: P.dim, cursor: "pointer", padding: 8, fontSize: 16 },
  nav: { display: "flex", borderBottom: `1px solid ${P.border}`, padding: "0 8px", overflowX: "auto" },
  navBtn: { flex: 1, background: "none", border: "none", cursor: "pointer", padding: "11px 6px 9px", display: "flex", flexDirection: "column", alignItems: "center", gap: 2, fontFamily: "inherit", transition: "color .2s" },
  fab: { position: "fixed", bottom: 22, right: 22, width: 54, height: 54, borderRadius: 27, background: `linear-gradient(135deg, ${P.warm}, #C4956A)`, color: P.bg, border: "none", cursor: "pointer", display: "flex", alignItems: "center", justifyContent: "center", boxShadow: `0 4px 20px ${P.warm}44`, zIndex: 50 },
  card: { background: P.card, borderRadius: 12, border: `1px solid ${P.border}` },
  prompt: { width: "100%", background: P.card, border: `1px solid ${P.border}`, borderRadius: 12, padding: 14, display: "flex", gap: 10, alignItems: "flex-start", cursor: "pointer", textAlign: "left", marginBottom: 10, fontFamily: "inherit" },
  overlay: { position: "fixed", inset: 0, background: "rgba(0,0,0,.72)", backdropFilter: "blur(4px)", zIndex: 100, display: "flex", alignItems: "flex-end", justifyContent: "center" },
  modal: { background: P.card, borderRadius: "18px 18px 0 0", width: "100%", maxHeight: "90vh", overflow: "auto", border: `1px solid ${P.border}`, borderBottom: "none" },
  modalHdr: { display: "flex", justifyContent: "space-between", alignItems: "center", padding: "18px 20px 0", position: "sticky", top: 0, background: P.card, zIndex: 10 },
  modalTitle: { color: P.text, fontSize: 17, fontFamily: "Georgia, 'Times New Roman', serif", margin: 0, fontWeight: 500 },
  closeBtn: { background: "none", border: "none", color: P.dim, fontSize: 17, cursor: "pointer", padding: 8 },
  label: { display: "block", color: P.muted, fontSize: 12, marginBottom: 7, fontWeight: 500 },
  dateIn: { background: P.bg, border: `1px solid ${P.border}`, borderRadius: 8, padding: "9px 11px", color: "#D1D5DB", fontSize: 14, fontFamily: "inherit", marginBottom: 14, width: "100%", boxSizing: "border-box", colorScheme: "dark" },
  chips: { display: "flex", flexWrap: "wrap", gap: 7, marginBottom: 14 },
  textarea: { width: "100%", background: P.bg, border: `1px solid ${P.border}`, borderRadius: 9, padding: 11, color: "#D1D5DB", fontSize: 14, fontFamily: "inherit", resize: "vertical", boxSizing: "border-box", lineHeight: 1.5 },
  textBtn: { background: "none", border: "none", cursor: "pointer", fontSize: 13, fontFamily: "inherit", padding: "6px 14px" },
  obText: { color: P.muted, fontSize: 15, lineHeight: 1.7, margin: "0 0 12px" },
  th: { color: P.dim, fontSize: 10, fontWeight: 500, padding: "6px 4px", borderBottom: `1px solid ${P.border}`, textAlign: "center" },
  td: { color: P.muted, fontSize: 11, padding: "8px 4px", borderBottom: `1px solid ${P.border}`, verticalAlign: "top" },
};

ReactDOM.createRoot(document.getElementById("root")).render(<App />);
</script>
</body>
</html>
